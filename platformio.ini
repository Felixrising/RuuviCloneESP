; PlatformIO Project Configuration File
;
;   Build options: build flags, source filter
;   Upload options: custom upload port, speed and extra flags
;   Library options: dependencies, extra library storages
;   Advanced options: extra scripting
;
; Please visit documentation for the other options and examples
; https://docs.platformio.org/page/projectconf.html

[platformio]
default_envs = m5stickcplus2
libdeps_dir = ${sysenv.USERPROFILE}/.platformio/libdeps-shared

[env]
platform = espressif32
framework = arduino
monitor_speed = 115200
lib_deps = 
	h2zero/NimBLE-Arduino @ ^2.3.7
	m5stack/M5Unified@^0.2.11
	m5stack/M5Unit-ENV @ ^1.3.1

[env:m5stickcplus2]
board = m5stick-c
board_upload.flash_size = 4MB
board_build.flash_size = 4MB
board_build.partitions = partitions_custom.csv
build_flags = 
	-DBOARD_PROFILE=1
	-DSENSOR_PROFILE=2
	-DI2C_SDA_PIN=32
	-DI2C_SCL_PIN=33
	-DDEBUG_SERIAL=1 ; enable serial logging to see actual advertising intervals
	-DDEBUG_LCD=1 ; show USB state on LCD for debugging power and usb and mode detection.
	;-DLCD_BRIGHTNESS=3 ; LCD brightness 0-255 (3 ≈ 1%, 40 ≈ 16%, 128 ≈ 50%, 255 = 100%)
	;-DDEV_MODE_ENABLE=1 ; explicitly enable DEV mode (211ms continuous advertising, ignores OPERATING_MODE)
	;-DDEBUG_LCD_FORCE_AWAKE=1
	; === OPERATING MODE SELECTION ===
	; Choose ONE of these modes:
	;-DOPERATING_MODE=0  ; FAST_ONLY - Always 1285ms intervals (max responsiveness, ~5-8mA)
	;-DOPERATING_MODE=1  ; SLOW_ONLY - Always 8995ms intervals (max battery, ~2-3mA)
	-DOPERATING_MODE=2   ; HYBRID - Smart switching (default, ~3-6mA)
  ;-DENABLE_LIGHT_SLEEP=1 ; enable light sleep between advertisements to save power
  -DENABLE_LIGHT_SLEEP=0 ; disable light sleep between advertisements for best BT advertisement reception.
	; === HYBRID MODE TIMING (only used if OPERATING_MODE=2) ===
	-DFAST_MODE_INITIAL_MS=3000   ; 3s: How long to stay in FAST mode after boot
	-DFAST_MODE_MOVEMENT_MS=6000  ; 6s: How long to stay in FAST mode after movement detected
	; === USB DETECTION TUNING (if USB flickering, increase these) ===
	; -DVBAT_T_CHARGE=10.0         ; Default: 8.0 mV/min to detect charging (higher = less sensitive)
	; -DVBAT_T_DISCHARGE=4.0       ; Default: 3.0 mV/min to detect discharge (higher = less sensitive)
	; -DVBAT_SCORE_MAX=15          ; Default: 12 samples needed to switch state (higher = slower switching)
	; === HISTORY LOGGING ===
	-DHISTORY_LOG_ENABLE=1       ; Enable history logging to LittleFS
	-DHISTORY_INTERVAL_SEC=300   ; Log every 5 minutes (300 seconds)
	-DHISTORY_MAX_DAYS=10        ; Keep 10 days of history
	-DHISTORY_FS_SIZE_KB=128     ; Allocate 128 KB for history storage
lib_ldf_mode = deep
lib_deps = 
	h2zero/NimBLE-Arduino @ ^2.3.7
	m5stack/M5Unified@^0.2.11
	m5stack/M5Unit-ENV @ ^1.3.1


[env:esp32s3]
board = esp32-s3-devkitc-1
board_upload.flash_size = 4MB
board_build.flash_size = 4MB
board_build.partitions = default.csv
build_flags = 
	-DARDUINO_USB_CDC_ON_BOOT=1
	-DBOARD_HAS_PSRAM
	-DBOARD_PROFILE=0
	-DSENSOR_PROFILE=0
	; === BATTERY MONITORING ===
	; Choose battery source: 0=Fixed voltage, 1=Internal IC, 2=ADC divider
	-DBATTERY_SOURCE=0           ; Default: Fixed 3.3V (no monitoring)
	;-DBATTERY_SOURCE=2          ; Enable for ADC battery monitoring
	; === ADC BATTERY MONITORING (only used if BATTERY_SOURCE=2) ===
	;-DBATTERY_ADC_PIN=1         ; GPIO1 for voltage reading
	;-DBATTERY_VDIV_R1=100000    ; 100k top resistor
	;-DBATTERY_VDIV_R2=100000    ; 100k bottom resistor (2:1 divider)
	;-DBATTERY_REAL_MIN_MV=3000  ; Empty battery voltage
	;-DBATTERY_REAL_MAX_MV=4200  ; Full battery voltage (1S Li-ion)
	;-DBATTERY_REPORT_MODE=1     ; 1=Clip to DF5 limits, 2=Map range
	; === OPERATING MODE ===
	-DOPERATING_MODE=2           ; HYBRID mode (default)
	-DFAST_MODE_INITIAL_MS=60000
	-DFAST_MODE_MOVEMENT_MS=60000